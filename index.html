<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>計算問題：計算20問</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
    <h1 id="main-heading">計算問題</h1>
    <p class="info" id="status-info">下のボタンを押して開始してください。</p>

    <div id="quiz-container">
        <div id="problem-container"></div>
        <input type="number" id="answer-input" class="hidden" placeholder="答えを入力">
        <button id="start-button">開始</button>
    </div>

    <div id="result-container" class="hidden">
        <h2>結果</h2>
        <p id="time-taken"></p>
        <p id="correct-answers"></p>
        <p id="accuracy-rate"></p>
    </div>

    <div id="detail-results" class="hidden">
        <h3>詳細結果</h3>
        <table id="detail-table">
            <thead>
                <tr>
                    <th>問題</th>
                    <th>自分の回答</th>
                    <th>正しい答え</th>
                    <th>正誤</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- ★ Googleフォーム送信用 iframe（必須） -->
<iframe name="hidden_iframe" style="display:none;"></iframe>

<script>
/* ===============================
   Googleフォーム設定（確定版）
================================ */
var FORM_URL =
"https://docs.google.com/forms/d/e/1FAIpQLSddAMxQ3_c_3jo6w9fpzmCq7qQVR2jXmkmaf0BLdLm4pJAe5A/formResponse";

var ENTRY_TIME     = "entry.339275990";
var ENTRY_SCORE    = "entry.779149345";
var ENTRY_ACCURACY = "entry.877128419";
var ENTRY_DETAIL   = "entry.1126612662";

// Googleフォームへ送信（Safari / iPad 対応）
function sendToGoogleForm(time, score, accuracy, detail) {
    var form = document.createElement("form");
    form.action = FORM_URL;
    form.method = "POST";
    form.target = "hidden_iframe";

    function add(name, value) {
        var input = document.createElement("input");
        input.type = "hidden";
        input.name = name;
        input.value = value;
        form.appendChild(input);
    }

    add(ENTRY_TIME, time);
    add(ENTRY_SCORE, score);
    add(ENTRY_ACCURACY, accuracy);
    add(ENTRY_DETAIL, detail);

    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
}

/* ===============================
   クイズ処理
================================ */
var quizData = [];
var problemContainer = document.getElementById("problem-container");
var answerInput = document.getElementById("answer-input");
var startButton = document.getElementById("start-button");
var resultContainer = document.getElementById("result-container");
var timeTakenDisplay = document.getElementById("time-taken");
var correctAnswersDisplay = document.getElementById("correct-answers");
var accuracyRateDisplay = document.getElementById("accuracy-rate");
var statusInfo = document.getElementById("status-info");
var mainHeading = document.getElementById("main-heading");

var currentProblemIndex = 0;
var startTime;

function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

// 問題生成
function generateProblems() {
    quizData.length = 0;

    // 1〜5
    for (var i = 0; i < 5; i++) {
        var a = getRandomInt(10, 99);
        var b = getRandomInt(100, 999);
        if (Math.random() < 0.5) {
            quizData.push({ problem: a + " + " + b, answer: a + b });
        } else {
            quizData.push({ problem: b + " - " + a, answer: b - a });
        }
    }

    // 6〜10
    for (var i = 0; i < 5; i++) {
        var a = getRandomInt(100, 999);
        var b = getRandomInt(100, 999);
        var max = Math.max(a, b);
        var min = Math.min(a, b);
        quizData.push({ problem: max + " - " + min, answer: max - min });
    }

    // 11〜15
    for (var i = 0; i < 5; i++) {
        var a = getRandomInt(10, 99);
        var b = getRandomInt(2, 9);
        quizData.push({ problem: a + " × " + b, answer: a * b });
    }

    // 16〜20
    for (var i = 0; i < 5; i++) {
        var q, d, n;
        do {
            q = getRandomInt(2, 20);
            d = getRandomInt(10, 99);
            n = q * d;
        } while (n < 100 || n > 999 || q === 10);

        quizData.push({ problem: n + " ÷ " + d, answer: q });
    }
}

// 問題表示
function displayProblem() {
    if (currentProblemIndex < quizData.length) {
        problemContainer.textContent = quizData[currentProblemIndex].problem;
        statusInfo.textContent =
            "第 " + (currentProblemIndex + 1) + " 問 / 20 問";
        answerInput.value = "";
        answerInput.focus();
    } else {
        endQuiz();
    }
}

// 開始
startButton.addEventListener("click", function () {
    generateProblems();
    currentProblemIndex = 0;

    startButton.classList.add("hidden");
    answerInput.classList.remove("hidden");
    problemContainer.classList.remove("hidden");
    statusInfo.classList.remove("hidden");
    resultContainer.classList.add("hidden");
    document.getElementById("detail-results").classList.add("hidden");

    mainHeading.textContent = "問題を解いてください";
    startTime = new Date();
    displayProblem();
});

// 回答
answerInput.addEventListener("keydown", function (e) {
    if (e.keyCode === 13 && answerInput.value !== "") {
        var ua = parseInt(answerInput.value, 10);
        var ca = quizData[currentProblemIndex].answer;

        quizData[currentProblemIndex].userAnswer = ua;
        quizData[currentProblemIndex].isCorrect = (ua === ca);

        currentProblemIndex++;
        displayProblem();
    }
});

// 終了
function endQuiz() {
    var timeDiff = (new Date() - startTime) / 1000;
    var correctCount = quizData.filter(q => q.isCorrect).length;
    var accuracy = (correctCount / quizData.length) * 100;

    answerInput.classList.add("hidden");
    problemContainer.classList.add("hidden");
    statusInfo.classList.add("hidden");
    resultContainer.classList.remove("hidden");

    mainHeading.textContent = "テスト終了！";
    timeTakenDisplay.textContent =
        "かかった時間: " + timeDiff.toFixed(2) + " 秒";
    correctAnswersDisplay.textContent =
        "正解数: " + correctCount + " / 20 問";
    accuracyRateDisplay.textContent =
        "正答率: " + accuracy.toFixed(1) + " %";

    // 詳細結果文字列
    var detailText = "";
    quizData.forEach(function (q, i) {
        detailText +=
            "第" + (i + 1) + "問 " +
            q.problem +
            " / 回答:" + q.userAnswer +
            " / 正解:" + q.answer +
            " / " + (q.isCorrect ? "○" : "×") +
            "\n";
    });

    // ★ Googleフォーム送信
    sendToGoogleForm(
        timeDiff.toFixed(2) + "秒",
        correctCount + "/20",
        accuracy.toFixed(1) + "%",
        detailText
    );

    showDetailResults();

    startButton.textContent = "もう一度開始";
    startButton.classList.remove("hidden");
}

// 詳細表示
function showDetailResults() {
    var tbody = document.querySelector("#detail-table tbody");
    tbody.innerHTML = "";
    quizData.forEach(function (q) {
        var tr = document.createElement("tr");
        tr.innerHTML =
            "<td>" + q.problem + "</td>" +
            "<td>" + q.userAnswer + "</td>" +
            "<td>" + q.answer + "</td>" +
            "<td>" + (q.isCorrect ? "○" : "×") + "</td>";
        tbody.appendChild(tr);
    });
    document.getElementById("detail-results").classList.remove("hidden");
}
</script>

</body>
</html>
